<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:title" content=UVMOD - Online Quansheng Firmware Patcher>
  <meta property="og:site_name" content=UVMOD>
  <meta property="og:url" content=https://whosmatt.github.io/uvmod />
  <meta property="og:description"
    content="Web-based tool to generate and flash customizable modded firmware, edit the configuration, and flash open source firmware for various Quansheng handheld radios.">
  <meta property="og:type" content=website>
  <meta property="og:image" content=https://whosmatt.github.io/uvmod/img/banner.webp>

  <title>UVMOD</title>

  <link rel="icon" type="image/x-icon" href="img/favicon.ico">
  <!-- Custom fonts for this template-->
  <link href="fonts/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="fonts/nunito.css" rel="stylesheet">

  <!-- Custom styles for this template-->
  <link href="css/sb-admin-2.min.css" rel="stylesheet">

  <!-- animated gradient background and other animations-->
  <style>
    html {
      height: 100%;
    }

    .bg-animated {
      min-height: 100%;
      background: linear-gradient(-45deg, #555555, #494949, #5e73b3, #4e73df);
      background-size: 400% 400%;
      background-attachment: fixed;
      animation: gradient 5s ease;
      animation-fill-mode: forwards;
    }

    @keyframes gradient {
      0% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    .marquee {
      display: none;
      left: 0;
      position: absolute;
      top: 0;
      z-index: 999999;
    }

    @keyframes fadeInFromTop {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-body {
      animation: fadeInFromTop 1s ease-in-out;
    }

    @keyframes fadeInFromBottom {
      from {
        opacity: 0;
        transform: translateY(+10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInFromLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .fade-in-from-bottom {
      animation: fadeInFromBottom 0.7s ease-out;
    }

    .fade-in-from-left {
      animation: fadeInFromLeft 0.7s ease-out;
    }

    checkbox {
      cursor: pointer;
    }
  </style>
</head>

<div class="marquee">
  <svg width="153px" height="69px">
    <g>
      <path class="logo"
        d="M140.186,63.52h-1.695l-0.692,5.236h-0.847l0.77-5.236h-1.693l0.076-0.694h4.158L140.186,63.52L140.186,63.52z M146.346,68.756h-0.848v-4.545l0,0l-2.389,4.545l-1-4.545l0,0l-1.462,4.545h-0.771l1.924-5.931h0.695l0.924,4.006l2.078-4.006 h0.848V68.756L146.346,68.756z M126.027,0.063H95.352c0,0-8.129,9.592-9.654,11.434c-8.064,9.715-9.523,12.32-9.779,13.02 c0.063-0.699-0.256-3.304-3.686-13.148C71.282,8.7,68.359,0.062,68.359,0.062H57.881V0L32.35,0.063H13.169l-1.97,8.131 l14.543,0.062h3.365c9.336,0,15.055,3.747,13.467,10.354c-1.717,7.24-9.91,10.416-18.545,10.416h-3.24l4.191-17.783H10.502 L4.34,37.219h20.578c15.432,0,30.168-8.13,32.709-18.608c0.508-1.906,0.443-6.67-0.764-9.527c0-0.127-0.063-0.191-0.127-0.444 c-0.064-0.063-0.127-0.509,0.127-0.571c0.128-0.062,0.383,0.189,0.445,0.254c0.127,0.317,0.19,0.57,0.19,0.57l13.083,36.965 l33.344-37.6h14.1h3.365c9.337,0,15.055,3.747,13.528,10.354c-1.778,7.24-9.972,10.416-18.608,10.416h-3.238l4.191-17.783h-14.481 l-6.159,25.976h20.576c15.434,0,30.232-8.13,32.709-18.608C152.449,8.193,141.523,0.063,126.027,0.063L126.027,0.063z M71.091,45.981c-39.123,0-70.816,4.512-70.816,10.035c0,5.59,31.693,10.034,70.816,10.034c39.121,0,70.877-4.444,70.877-10.034 C141.968,50.493,110.212,45.981,71.091,45.981L71.091,45.981z M68.55,59.573c-8.956,0-16.196-1.523-16.196-3.365 c0-1.84,7.239-3.303,16.196-3.303c8.955,0,16.195,1.463,16.195,3.303C84.745,58.05,77.505,59.573,68.55,59.573L68.55,59.573z" />
    </g>
  </svg>
</div>

<body id="page-top" class="bg-animated">

  <!-- Page Wrapper -->
  <div id="wrapper animated--grow-in" class="wrapper">

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="w-100">

      <!-- Main Content -->
      <div id="content" class="fade-in-from-bottom">

        <!-- Begin Page Content -->
        <div class="container mt-4" style="max-width: 1440px;">

          <!-- Content Row -->
          <div class="row">
            <div class="col-lg-12 mb-4">
              <!-- Instructions Card (Already spans full width) -->
              <div class="card shadow mb-4">
                <a href="#instructions" class="d-block card-header py-3" data-toggle="collapse" role="button">
                  <h6 class="m-0 font-weight-bold text-primary">Instructions</h6>
                </a>
                <div id="instructions" class="card-body collapse">
                  <h2 class="mb-4">IU2FRL Flasher (derived from UVMOD)</h2>
                  <p>This tool provides a simple web interface for flashing firmwares to Quansheng UV-K5, UV-K6,
                    UV-K5(8), and UV-5R
                    Plus handheld radios. It works by connecting to your radio through a compatible programming cable
                    using Web Serial API.</p>

                  <h3 class="mt-4">How the Tool Works</h3>
                  <ol>
                    <li>Select your desired firmware from the dropdown menu on the left panel.</li>
                    <li>Connect your radio in bootloader mode (by holding PTT while powering on).</li>
                    <li>Click "Flash firmware to the radio" to initiate the flashing process.</li>
                    <li>The tool communicates with your radio via Serial API, uploads the firmware binary, and provides
                      real-time progress in the console window.</li>
                  </ol>

                  <h3 class="mt-4">Radio Configurator</h3>
                  <p>The right panel provides a configuration interface that allows you to:</p>
                  <ol>
                    <li>Read your radio's current configuration settings.</li>
                    <li>Modify settings without reflashing the entire firmware.</li>
                    <li>Write changes back to the radio.</li>
                    <li>Create and restore configuration backups.</li>
                  </ol>

                  <h3 class="mt-4">Technical Details</h3>
                  <p>The firmware flashing process utilizes the Web Serial API available in modern browsers to establish
                    direct communication with your radio's bootloader. The tool performs the following operations:</p>
                  <ol>
                    <li>Loads the selected firmware binary from the server.</li>
                    <li>Establishes a serial connection to the radio's bootloader.</li>
                    <li>Sends the appropriate commands to erase and write to the radio's flash memory.</li>
                    <li>Verifies successful writing to ensure firmware integrity.</li>
                  </ol>

                  <h3 class="mt-4">Requirements</h3>
                  <p>To use this tool effectively:</p>
                  <ul>
                    <li>Use a Chromium-based browser (Chrome, Edge, Opera) which supports Web Serial API.</li>
                    <li>Have appropriate drivers installed for your programming cable (typically ch340, ch341 or cp210x
                      chips).</li>
                    <li>Connect your radio in bootloader mode before attempting to flash.</li>
                    <li>Ensure you have a stable connection throughout the flashing process.</li>
                  </ul>

                  <p class="mt-4 font-weight-bold">Note: If you prefer to download the firmware without flashing, you
                    can use the "Download firmware to PC" button and flash manually using official tools.</p>
                </div>
              </div>

              <!-- Console Card - Now spans full width -->
              <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex">
                  <div class="mr-auto">
                    <h6 class="m-0 font-weight-bold text-info">Console</h6>
                  </div>
                </div>
                <div class="card-body">
                  <div class="d-flex justify-content-center">
                    <textarea id="console" class="w-100 form-control" style="height: 10em;" readonly>Waiting</textarea>
                  </div>
                </div>
              </div>

              <!-- Firmware Updater - Now spans full width -->
              <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex">
                  <div class="mr-auto">
                    <h6 class="m-0 font-weight-bold text-primary">Firmware updater</h6>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <div class="input-group">
                        <select id="firmwareFileSelect" class="form-control" onchange="handleFirmwareSelect()">
                          <option value="" selected>Custom firmware file</option>
                          <option value="fw/k5_v2.01.26_publish.bin">Original firmware V1.26</option>
                          <option value="fw/firmware.N3.40.bin">IJV V3.4 with no hardware modification</option>
                          <option value="fw/firmware.X3.40.bin">IJV V3.4 modified with 24M01/24M02 EEPROM (999ch)</option>
                          <option value="fw/firmware.S3.40.bin">IJV V3.4 modified with slow 24M01/24M02 EEPROM (999ch)</option>
                          <option value="fw/fagci-r3b0rn-2025-01-19-buggy-nightly1-SNR-CLOSE-43.bin">FAGCI Nightly 2025-01-19 (any EEPROM)</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <div class="custom-file">
                        <input id="customFirmwareInput" type="file" class="custom-file-input" accept=".bin" onchange="handleCustomFirmwareSelect()">
                        <label id="customFirmwareLabel" class="custom-file-label" for="customFirmwareInput">Upload custom firmware</label>
                      </div>
                    </div>
                  </div>
                  
                  <div class="d-flex">
                    <a id="downloadFirmwareButton" class="btn btn-dark btn-icon-split mr-1 w-100" onclick="downloadFirmware()">
                      <span class="icon text-white-50">
                        <i class="fas fa-download"></i>
                      </span>
                      <span class="text w-100">Download firmware to PC</span>
                    </a>
                    <a id="flashButton" class="btn btn-dark btn-icon-split w-100">
                      <span class="icon text-white-50">
                        <i class="fab fa-usb"></i>
                      </span>
                      <span class="text w-100">Flash firmware to the radio</span>
                    </a>
                  </div>
                </div>
              </div>

              <!-- Radio Configurator - Now spans full width -->
              <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex">
                  <div class="mr-auto">
                    <h6 class="m-0 font-weight-bold text-success">Radio Configurator</h6>
                  </div>
                </div>
                <div class="card-body">
                  <div id="configContainer" class="mb-4">
                    <!-- Configuration content will be loaded here -->
                  </div>

                  <!-- Added configuration selection row -->
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <div class="input-group">
                        <select id="configFileSelect" class="form-control" onchange="handleConfigSelect()">
                          <option value="" selected>Custom config file</option>
                          <option value="config/ijv_v3.40_config.bin">IJV V3.40 Config</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <div class="input-group mb-3">
                        <div class="input-group-prepend">
                          <div class="input-group-text">
                            <input id="automaticBackupCheckbox" style="cursor: pointer;" type="checkbox" checked>
                          </div>
                        </div>
                        <label for="automaticBackupCheckbox" class="form-control" readonly style="cursor: pointer;">Save
                          automatic backup</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="custom-file mb-3">
                        <input id="backupFileInput" type="file" class="custom-file-input" accept=".bin"
                          onchange="handleBackupFileSelect()">
                        <label id="backupFileLabel" class="custom-file-label" for="backupFileInput">Import
                          backup</label>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex">
                    <a id="readConfigButton" class="btn btn-success btn-icon-split mr-1 w-100">
                      <span class="icon text-white-50">
                        <i class="fas fa-sign-out-alt"></i>
                      </span>
                      <span class="text w-100">Read Config</span>
                    </a>
                    <a id="writeConfigButton" class="btn btn-success btn-icon-split disabled w-100">
                      <span class="icon text-white-50">
                        <i class="fas fa-sign-in-alt"></i>
                      </span>
                      <span class="text w-100">Write Config</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- /.container-fluid -->

      </div>
      <!-- End of Main Content -->

    </div>
    <!-- End of Content Wrapper -->

  </div>
  <!-- End of Page Wrapper -->

  <!-- Bootstrap core JavaScript-->
  <script src="js/vendor/jquery.min.js"></script>
  <script src="js/vendor/bootstrap.bundle.min.js"></script>
  <script src="js/vendor/bs-custom-file-input.min.js"></script>

  <!-- Core plugin JavaScript-->

  <!-- Patcher JavaScript -->
  <script src="js/fwpack.js"></script>
  <script src="js/qsSerial.js"></script>
  <script src="js/modframework.js"></script>
  <script src="js/tool_patcher.js"></script>
  <script src="js/tool_configurator.js"></script>

  <!-- Easter egg, click the title -->
  <script>
    const marqueediv = document.getElementById("marquee");

    (function ($, window, undefined) {
      $.fn.marqueeify = function (options) {
        var settings = $.extend({
          horizontal: true,
          vertical: true,
          speed: 100, // In pixels per second
          container: $(this).parent(),
          bumpEdge: function () { }
        }, options);

        return this.each(function () {
          var containerWidth, containerHeight, elWidth, elHeight, move, getSizes,
            $el = $(this);

          getSizes = function () {
            containerWidth = settings.container.outerWidth();
            containerHeight = settings.container.outerHeight();
            elWidth = $el.outerWidth();
            elHeight = $el.outerHeight();
          };

          move = {
            right: function () {
              $el.animate({ left: (containerWidth - elWidth) }, {
                duration: ((containerWidth / settings.speed) * 1000), queue: false, easing: "linear", complete: function () {
                  settings.bumpEdge();
                  move.left();
                }
              });
            },
            left: function () {
              $el.animate({ left: 0 }, {
                duration: ((containerWidth / settings.speed) * 1000), queue: false, easing: "linear", complete: function () {
                  settings.bumpEdge();
                  move.right();
                }
              });
            },
            down: function () {
              $el.animate({ top: (containerHeight - elHeight) }, {
                duration: ((containerHeight / settings.speed) * 1000), queue: false, easing: "linear", complete: function () {
                  settings.bumpEdge();
                  move.up();
                }
              });
            },
            up: function () {
              $el.animate({ top: 0 }, {
                duration: ((containerHeight / settings.speed) * 1000), queue: false, easing: "linear", complete: function () {
                  settings.bumpEdge();
                  move.down();
                }
              });
            }
          };
          getSizes();
          if (settings.horizontal) {
            move.right();
          }
          if (settings.vertical) {
            move.down();
          }

          // Make that shit responsive!
          $(window).resize(function () {
            getSizes();
          });
        });
      };
    })(jQuery, window);

    var marqueeified = false;
    function easterEgg() {
      $('.marquee').toggle();
      if (!marqueeified) {
        $('.marquee').marqueeify({
          speed: 150,
          bumpEdge: function () {
            var newColor = "hsl(" + Math.floor(Math.random() * 360) + ", 100%, 50%)";
            $('.marquee .logo').css('fill', newColor);
          }
        });
        marqueeified = true;
      }
    };

    function downloadFirmware() {
      const firmwareSelect = document.getElementById('firmwareFileSelect');
      const selectedFirmware = firmwareSelect.value;

      if (!selectedFirmware) {
        alert('Please select a firmware to download.');
        return;
      }

      const link = document.createElement('a');
      link.href = selectedFirmware;
      link.download = selectedFirmware.split('/').pop();
      link.click();
    }

    function flashFirmware() {
      const firmwareSelect = document.getElementById('firmwareFileSelect');
      const selectedFirmware = firmwareSelect.value;
      const consoleElement = document.getElementById('console');

      if (!selectedFirmware) {
        consoleElement.value = 'Error: Please select a firmware to flash.';
        return;
      }

      consoleElement.value = 'Preparing to flash firmware...\n';

      // Fetch the firmware file
      fetch(selectedFirmware)
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to load firmware file');
          }
          return response.arrayBuffer();
        })
        .then(firmwareBuffer => {
          consoleElement.value += 'Firmware loaded successfully.\n';
          consoleElement.value += 'Searching for radio...\n';

          // Use the qsSerial module to flash the firmware
          if (typeof qsSerial !== 'undefined' && qsSerial.flashFirmware) {
            qsSerial.flashFirmware(new Uint8Array(firmwareBuffer),
              // Progress callback
              (progress) => {
                consoleElement.value = `Flashing: ${Math.round(progress * 100)}%\n` + consoleElement.value;
              },
              // Success callback
              () => {
                consoleElement.value = 'Firmware successfully flashed to radio!\n' + consoleElement.value;
              },
              // Error callback
              (error) => {
                consoleElement.value = `Error: ${error}\n` + consoleElement.value;
              }
            );
          } else {
            consoleElement.value += 'Error: Flash functionality not available. Make sure you are using a compatible browser.\n';
          }
        })
        .catch(error => {
          consoleElement.value += `Error: ${error.message}\n`;
        });
    }

    // Add these functions to handle the mutual exclusivity
    document.addEventListener('DOMContentLoaded', function () {
      const configFileSelect = document.getElementById('configFileSelect');
      const backupFileInput = document.getElementById('backupFileInput');
      const writeConfigButton = document.getElementById('writeConfigButton');

      // When jQuery is initialized, apply bs-custom-file-input for better file input UI
      bsCustomFileInput.init();

      // Connect flash button to the flashFirmware function
      document.getElementById('flashButton').addEventListener('click', flashFirmware);
    });

    // Handle dropdown selection change
    function handleConfigSelect() {
      const configFileSelect = document.getElementById('configFileSelect');
      const backupFileInput = document.getElementById('backupFileInput');
      const writeConfigButton = document.getElementById('writeConfigButton');

      if (configFileSelect.value) {
        // Clear and disable the file input
        backupFileInput.value = '';
        backupFileInput.setAttribute('disabled', 'disabled');
        document.getElementById('backupFileLabel').textContent = 'Import backup';

        // Load the selected config and enable write button
        loadPresetConfig();
      } else {
        // Re-enable the file input
        backupFileInput.removeAttribute('disabled');
        writeConfigButton.classList.add('disabled');
      }
    }

    function handleBackupFileSelect() {
      const file = document.getElementById('backupFileInput').files[0];
      const configFileSelect = document.getElementById('configFileSelect');
      const writeConfigButton = document.getElementById('writeConfigButton');

      if (file) {
        // If a file is selected, reset and disable the dropdown
        configFileSelect.value = '';
        configFileSelect.setAttribute('disabled', 'disabled');

        // Update the file label with the selected filename
        document.getElementById('backupFileLabel').textContent = file.name;

        // Process the file - this function should be defined in tool_configurator.js
        loadConfigFile(file);
      } else {
        // If no file is selected, re-enable the dropdown
        configFileSelect.removeAttribute('disabled');
        writeConfigButton.classList.add('disabled');
      }
    }

    // Add this to the script section

    // Global variable to store custom firmware
    let customFirmwareBuffer = null;

    document.addEventListener('DOMContentLoaded', function() {
      const firmwareFileSelect = document.getElementById('firmwareFileSelect');
      const customFirmwareInput = document.getElementById('customFirmwareInput');
      const flashButton = document.getElementById('flashButton');
      const downloadFirmwareButton = document.getElementById('downloadFirmwareButton');

      // Apply custom file input styling
      bsCustomFileInput.init();

      // Connect flash button to the flashFirmware function
      flashButton.addEventListener('click', flashFirmware);
      
      // Initial state check
      if (firmwareFileSelect.value === '') {
        downloadFirmwareButton.classList.add('disabled');
      }
    });

    // Handle firmware dropdown selection
    function handleFirmwareSelect() {
      const firmwareFileSelect = document.getElementById('firmwareFileSelect');
      const customFirmwareInput = document.getElementById('customFirmwareInput');
      const downloadFirmwareButton = document.getElementById('downloadFirmwareButton');
      
      // Reset custom firmware buffer
      customFirmwareBuffer = null;
      
      if (firmwareFileSelect.value) {
        // Clear and disable the file input
        customFirmwareInput.value = '';
        customFirmwareInput.setAttribute('disabled', 'disabled');
        document.getElementById('customFirmwareLabel').textContent = 'Upload custom firmware';
        
        // Enable download button
        downloadFirmwareButton.classList.remove('disabled');
      } else {
        // Re-enable the file input
        customFirmwareInput.removeAttribute('disabled');
        
        // Disable download button (can't download what's not selected)
        downloadFirmwareButton.classList.add('disabled');
      }
    }

    // Handle custom firmware file selection
    function handleCustomFirmwareSelect() {
      const file = document.getElementById('customFirmwareInput').files[0];
      const firmwareFileSelect = document.getElementById('firmwareFileSelect');
      const downloadFirmwareButton = document.getElementById('downloadFirmwareButton');
      
      if (file) {
        // If a file is selected, reset and disable the dropdown
        firmwareFileSelect.value = '';
        firmwareFileSelect.setAttribute('disabled', 'disabled');
        
        // Update the file label with the selected filename
        document.getElementById('customFirmwareLabel').textContent = file.name;
        
        // Disable download button for custom uploads
        downloadFirmwareButton.classList.add('disabled');
        
        // Read the file into memory
        const reader = new FileReader();
        reader.onload = function(e) {
          customFirmwareBuffer = new Uint8Array(e.target.result);
          log(`Custom firmware loaded: ${file.name} (${customFirmwareBuffer.length} bytes)`);
        };
        
        reader.onerror = function() {
          log('Error reading firmware file.');
          customFirmwareBuffer = null;
        };
        
        reader.readAsArrayBuffer(file);
      } else {
        // If no file is selected, re-enable the dropdown
        firmwareFileSelect.removeAttribute('disabled');
        document.getElementById('customFirmwareLabel').textContent = 'Upload custom firmware';
      }
    }

    // Modified download firmware function
    function downloadFirmware() {
      const firmwareFileSelect = document.getElementById('firmwareFileSelect');
      const selectedFirmware = firmwareFileSelect.value;
      
      if (!selectedFirmware) {
        log('Please select a firmware to download.');
        return;
      }
      
      const link = document.createElement('a');
      link.href = selectedFirmware;
      link.download = selectedFirmware.split('/').pop();
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Modified flash firmware function to handle both dropdown and custom file
    function flashFirmware() {
      const firmwareFileSelect = document.getElementById('firmwareFileSelect');
      const selectedFirmware = firmwareFileSelect.value;
      const consoleElement = document.getElementById('console');
      
      // Clear previous console output
      consoleElement.value = 'Preparing to flash firmware...\n';
      
      // Use custom firmware if available, otherwise use selected firmware
      if (customFirmwareBuffer) {
        // Flash the custom firmware that's already loaded
        log('Using custom firmware from file upload');
        
        // Flash the firmware buffer directly
        if (typeof qsSerial !== 'undefined' && qsSerial.flashFirmware) {
          qsSerial.flashFirmware(customFirmwareBuffer,
            // Progress callback
            (progress) => {
              consoleElement.value = `Flashing: ${Math.round(progress * 100)}%\n` + consoleElement.value;
            },
            // Success callback
            () => {
              consoleElement.value = 'Firmware successfully flashed to radio!\n' + consoleElement.value;
            },
            // Error callback
            (error) => {
              consoleElement.value = `Error: ${error}\n` + consoleElement.value;
            }
          );
        } else {
          consoleElement.value += 'Error: Flash functionality not available. Make sure you are using a compatible browser.\n';
        }
        
        return;
      }
      
      // Handle firmware from dropdown
      if (!selectedFirmware) {
        consoleElement.value = 'Error: Please select a firmware or upload a custom firmware file.\n';
        return;
      }
      
      // Fetch the firmware file from the server
      fetch(selectedFirmware)
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to load firmware file');
          }
          return response.arrayBuffer();
        })
        .then(firmwareBuffer => {
          consoleElement.value += 'Firmware loaded successfully.\n';
          consoleElement.value += 'Searching for radio...\n';
          
          // Use the qsSerial module to flash the firmware
          if (typeof qsSerial !== 'undefined' && qsSerial.flashFirmware) {
            qsSerial.flashFirmware(new Uint8Array(firmwareBuffer),
              // Progress callback
              (progress) => {
                consoleElement.value = `Flashing: ${Math.round(progress * 100)}%\n` + consoleElement.value;
              },
              // Success callback
              () => {
                consoleElement.value = 'Firmware successfully flashed to radio!\n' + consoleElement.value;
              },
              // Error callback
              (error) => {
                consoleElement.value = `Error: ${error}\n` + consoleElement.value;
              }
            );
          } else {
            consoleElement.value += 'Error: Flash functionality not available. Make sure you are using a compatible browser.\n';
          }
        })
        .catch(error => {
          consoleElement.value += `Error: ${error.message}\n`;
        });
    }

    // Utility function to log to console
    function log(message, replace = false) {
      const consoleElement = document.getElementById('console');
      if (replace && consoleElement.value.includes('\n')) {
        // Replace the last line
        const lines = consoleElement.value.split('\n');
        lines[0] = message;
        consoleElement.value = lines.join('\n');
      } else {
        // Add new line
        consoleElement.value = message + '\n' + consoleElement.value;
      }
    }
  </script>


</body>

</html>